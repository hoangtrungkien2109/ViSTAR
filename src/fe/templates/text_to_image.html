{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block content %}
<html>
<head>
    <title>Real-time Text and Image Streaming</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .input-area {
            margin-bottom: 20px;
        }
        #textInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid black;
        }
        #imageDisplay {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 1px solid #ccc;
        }
        .status {
            margin-top: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-area">
            <textarea id="textInput" rows="4" placeholder="Enter text to send..."></textarea>
            <button class="btn btn-primary block w-full max-w-xs mx-auto" onclick="sendText()">Send Text</button>
        </div>
        <div class="image-area">
            <img id="imageDisplay" alt="Received image will appear here" style="width: 480px; height: 720px; object-fit: contain;">
            <div id="status" class="status">Not connected</div>
        </div>
    </div>

    <script>
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connect() {
            ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = function() {
                document.getElementById('status').textContent = 'Connected';
                reconnectAttempts = 0;
            };

            ws.onmessage = function(event) {
                if (event.data.startsWith('data:image')) {
                    console.log("Show image");
                    document.getElementById('imageDisplay').src = event.data;
                }
            };

            ws.onclose = function() {
                document.getElementById('status').textContent = 'Disconnected';
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connect, 1000 * reconnectAttempts);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('status').textContent = 'Error: ' + error;
            };
        }

        function sendText() {
            const textInput = document.getElementById('textInput');
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(textInput.value);
                textInput.value = '';
            } else {
                document.getElementById('status').textContent = 'Not connected. Trying to reconnect...';
                connect();
            }
        }

        // Initial connection
        connect();
    </script>
</body>
</html>
{% endblock %}